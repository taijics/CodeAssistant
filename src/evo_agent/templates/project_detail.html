{% extends "base.html" %}
{% block content %}
<div class="panel two-col">
  <aside class="card sidebar">
    <h3>{{ project.name }}</h3>
    <p class="muted">{{ project.root }}</p>
    <dl class="info-list">
      <dt>简介</dt><dd>{{ project.config.description or '—' }}</dd>
      <dt>添加时间</dt><dd>{{ project.get('created_at','—') }}</dd>
      <dt>文件总数</dt><dd>{{ meta.project_file_count or '—' }}</dd>
      <dt>符号总数</dt><dd>{{ meta.symbol_count or '—' }}</dd>
      <dt>修改次数（placeholder）</dt><dd>{{ project.config.get('mod_count','—') }}</dd>
      <dt>前端架构</dt><dd>{{ project.config.get('frontend','—') }}</dd>
      <dt>server 架构</dt><dd>{{ project.config.get('server','—') }}</dd>
      <dt>后台管理端架构</dt><dd>{{ project.config.get('admin','—') }}</dd>
    </dl>

    <div class="box">
      <h4>快速操作</h4>
      <form method="post" action="/projects/{{ project.id }}/plan" id="plan-form">
        <label>任务需求（简述）</label>
        <textarea name="task" rows="3" placeholder="例如：为登录添加刷新 token" required></textarea>
        <p class="form-actions">
          <button class="btn-primary" type="submit">生成 Spec</button>
        </p>
      </form>

      <div style="margin-top:1rem">
        <button class="btn" id="btn-open-files">查看文件树</button>
        <button class="btn" id="btn-search" data-pid="{{ project.id }}">搜索项目</button>
      </div>
    </div>
  </aside>

  <section class="workspace card">
    <div class="workspace-toolbar">
      <div class="toolbar-left">
        <input id="file-filter" placeholder="过滤文件名或路径，回车确认" />
      </div>
      <div class="toolbar-right">
        <a class="btn" href="/projects/{{ project.id }}/artifacts/spec.md" target="_blank">打开 Spec</a>
        <a class="btn" href="/projects/{{ project.id }}/artifacts/llm_response.txt" target="_blank">查看响应</a>
      </div>
    </div>

    <div class="workspace-body">
      <div class="panel file-panel" id="file-panel">
        <h4>文件树</h4>
        <div id="file-tree" class="file-tree">加载中...</div>
      </div>

      <div class="panel editor-panel" id="editor-panel">
        <h4>搜索结果 / 编辑</h4>
        <div class="two-pane">
          <div class="pane left-pane" id="search-results">
            <div class="empty">点击“搜索项目”输入查询词开始检索（功能尚在后端实现）</div>
          </div>
          <div class="pane right-pane">
            <textarea id="editor" placeholder="在此编辑整理好的文档（Spec 或说明），人工审核后点击提交给 LLM..."></textarea>
            <div class="editor-actions">
              <button class="btn-primary" id="btn-save-doc">保存到 artifacts/spec.md</button>
              <a class="btn" href="/projects/{{ project.id }}/artifacts/spec.md" target="_blank">打开当前 Spec</a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </section>
</div>

<!-- Search modal -->
<div id="search-modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3>搜索项目（实体 / 页面 / service / controller）</h3>
    <input id="search-input" placeholder="输入关键词，例：登录 refresh token" />
    <div class="modal-actions">
      <button class="btn-primary" id="search-confirm" data-pid="{{ project.id }}">搜索</button>
      <button class="btn" id="search-cancel">取消</button>
    </div>
  </div>
</div>

<script>
  // expose pid for static app.js
  window.EVO_PROJECT_ID = "{{ project.id }}";
  window.EVO_PROJECT_ROOT = "{{ project.root }}";
</script>
{% endblock %}